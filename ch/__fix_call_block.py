from pathlib import Path
path = Path('src/app/Main.tsx')
text = path.read_text(encoding='utf-8')
needle = '          {selectedHaven === "__dms__" && selectedDM && activeCallDM === selectedDM && callState !== \'idle\' && (() => {'
start = text.index(needle)
end = text.index('          {showTipsBanner', start)
new_block = """          {selectedHaven === \"__dms__\" && selectedDM && activeCallDM === selectedDM && callState !== 'idle' && (() => {\n            const dm = dms.find(d => d.id === selectedDM);\n            const fallback = (dm ? dm.users : []).map(user => ({ user, status: 'ringing' as const }));\n            const participantCards = (callParticipants.length ? callParticipants : fallback).filter(p => !!p.user);\n            const label = callState === 'calling' ? 'Calling…' : 'In call';\n            return (\n              <div\n                onContextMenu={(e) => openCtx(e, { type: 'call', data: { room: activeCallDM } })}\n                style={{\n                  position: 'fixed',\n                  bottom: isMobile ? 76 : 96,\n                  left: isMobile ? 8 : '50%',\n                  transform: isMobile ? 'none' : 'translateX(-50%)',\n                  width: isMobile ? 'calc(100vw - 16px)' : 'min(920px, 94vw)',\n                  zIndex: 82,\n                  padding: 12,\n                  borderRadius: 12,\n                  background: '#0b1222',\n                  border: '1px solid #1f2937',\n                  color: '#e5e7eb',\n                  boxShadow: '0 16px 40px rgba(0,0,0,0.35)'\n                }}\n              >\n                <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 10 }}>\n                  <span style={{ width: 10, height: 10, borderRadius: 999, background: callState === 'calling' ? '#f59e0b' : '#22c55e', display: 'inline-block' }} />\n                  <div style={{ fontWeight: 700 }}>{label}</div>\n                  {callInitiator && <div style={{ fontSize: 12, color: '#a5b4fc' }}>Started by @{callInitiator}</div>}\n                  <div style={{ marginLeft: 'auto', color: '#a5b4fc', fontVariantNumeric: 'tabular-nums' }}>\n                    {`${Math.floor(callElapsed / 60).toString().padStart(1, '0')}:${(callElapsed % 60).toString().padStart(2, '0')}`}\n                  </div>\n                </div>\n                <div style={{ display: 'flex', gap: 10, flexWrap: 'wrap', marginBottom: 10 }}>\n                  {participantCards.map(part => {\n                    const user = part.user;\n                    const profile = userProfileCache[user];\n                    const avatar = profile?.avatarUrl || '/favicon.ico';\n                    const display = profile?.displayName || user;\n                    const color = part.status === 'connected' ? '#22c55e' : '#f59e0b';\n                    return (\n                      <div key={user} style={{ padding: '6px 10px', borderRadius: 8, border: '1px solid #1f2937', background: '#0f172a', display: 'flex', alignItems: 'center', gap: 8, minWidth: 160, flex: '1 1 220px' }}>\n                        <img src={avatar} alt={display} style={{ width: 32, height: 32, borderRadius: '50%', border: `2px solid ${color}` }} />\n                        <div style={{ display: 'grid', gap: 2 }}>\n                          <div style={{ fontWeight: 600 }}>{display}{user === username ? ' (you)' : ''}</div>\n                          <div style={{ fontSize: 12, color }}>{part.status === 'connected' ? 'Connected' : 'Ringing'}</div>\n                        </div>\n                      </div>\n                    );\n                  })}\n                  {participantCards.length === 0 && (\n                    <div style={{ color: '#9ca3af', fontSize: 12 }}>No participants yet.</div>\n                  )}\n                </div>\n                <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>\n                  <button\n                    type=\"button\"\n                    onClick={toggleMute}\n                    className=\"btn-ghost\"\n                    style={{ padding: '8px 12px', borderRadius: 8, border: '1px solid #1f2937', background: isMuted ? '#111827' : '#0f172a', color: '#e5e7eb' }}\n                  >\n                    <FontAwesomeIcon icon={isMuted ? faMicrophoneSlash : faMicrophone} /> {isMuted ? 'Unmute' : 'Mute'}\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={toggleDeafen}\n                    className=\"btn-ghost\"\n                    style={{ padding: '8px 12px', borderRadius: 8, border: '1px solid #1f2937', background: isDeafened ? '#111827' : '#0f172a', color: '#e5e7eb' }}\n                  >\n                    <FontAwesomeIcon icon={faVolumeXmark} /> {isDeafened ? 'Undeafen' : 'Deafen'}\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={() => {\n                      setSelectedHaven('__dms__');\n                      if (activeCallDM) setSelectedDM(activeCallDM);\n                      setShowMobileNav(false);\n                      setTimeout(() => {\n                        const el = chatScrollRef.current;\n                        if (el) el.scrollTop = el.scrollHeight;\n                      }, 50);\n                    }}\n                    className=\"btn-ghost\"\n                    style={{ padding: '8px 12px', borderRadius: 8, border: '1px solid #1f2937', background: '#0f172a', color: '#e5e7eb' }}\n                  >\n                    <FontAwesomeIcon icon={faPhone} /> Jump to DM\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={endCall}\n                    className=\"btn-ghost\"\n                    style={{ padding: '8px 12px', borderRadius: 8, border: '1px solid #7f1d1d', background: '#7f1d1d', color: '#fff', marginLeft: 'auto' }}\n                  >\n                    Hang up\n                  </button>\n                </div>\n              </div>\n            );\n          })()}\n"""
text = text[:start] + new_block + text[end:]
path.write_text(text, encoding='utf-8')
